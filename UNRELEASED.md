# Unreleased

### Added
- [CLI]: `ails setup` command — auto-detects agents and writes MCP config (`.mcp.json`, `.vscode/mcp.json`, `.codex/mcp.json`)
- [CLI]: `--format github` output — emits `::error`/`::warning` workflow commands for inline PR annotations in GitHub Actions
- [CI]: Composite GitHub Action (`action/`) — installs CLI, runs check, writes step summary, gates on score/violations
- [CORE]: `recommended_path` global config override — point CLI at a local recommended rules repo for development
- [CLI]: `--verbose` / `-v` flag for `ails check` — shows per-file PASS/FAIL checks with rule titles
- [CLI]: `ails heal` auto-fix phase — silently applies safe fixes before semantic prompts
- [CLI]: `ails heal` command for interactive semantic rule evaluation (pass/fail/skip/dismiss)
- [CORE]: Auto-fixer registry with 5 additive fixers (constraints, commands, testing, sections, structure)
- [MCP]: `heal` tool — applies auto-fixes and returns remaining semantic judgment requests
- [CORE]: Structural hash for smarter cache invalidation — cosmetic edits no longer clear semantic verdicts
- [CORE]: Pure Python regex engine replacing OpenGrep binary
- [CORE]: Adversarial test suite for regex engine (76 tests)
- [HOOKS]: PostToolUse auto-validation hook for instruction file edits

### Changed
- [CLI]: Renamed MCP entry point `ails-mcp` → `reporails-mcp` (old name kept as deprecated alias, remove ~0.5.0)
- [CLI]: MCP CTA in `ails check` output now points to `ails setup` instead of manual `claude mcp add` command
- [CLI]: `ails update --cli` now prints hint to run `ails setup` after upgrade
- [NPM]: Simplified npm wrapper — `install`/`uninstall` replaced by `setup` proxy (no `claude` CLI dependency)
- [META]: Check skill uses MCP tools instead of shelling out to `uv run ails`
- [REPO]: Gitignore development internals (docs/specs, CLAUDE.md, .claude/rules, hooks, skills, settings)
- [CORE]: Scan targets now include config files for path-filtered rules (`get_all_scannable_files`)
- [JSON]: `pending_semantic` and `skipped_experimental` omitted from JSON output when absent (avoids null-chaining)
- [META]: Version bump to 0.3.0
- [DOCS]: Updated all specs and README to reflect v0.3.0 (regex engine, new commands, current module structure)
- [MCP]: Validate tool returns structured JSON instead of formatted text
- [MCP]: Semantic judgment requests now carry full file content (up to 8KB) instead of 5-line snippets
- [MCP]: Replaced `_instructions` text blob with structured `_semantic_workflow` object for agent consumption
- [MCP]: Rewrote all tool descriptions with output format info and usage guidance
- [MCP]: Content-aware circuit breaker tracks file mtimes instead of blunt call counter (allows edit-validate cycles)
- [MCP]: Error responses now return structured JSON with `error` and `message` keys

### Removed
- [CORE]: OpenGrep binary dependency and download pipeline
- [CORE]: Semgrepignore support
- [CLI]: OpenGrep version display from `ails version`

### Fixed
- [MCP]: Judge tool output now includes parsed verdict details (rule, file, verdict, reason) instead of bare count
- [MCP]: Judge tool rejects path-traversal verdicts referencing files outside the project directory
- [DOCS]: Replaced all short rule IDs (S1, C4, etc.) with full coordinate format (CORE:S:0005, CORE:C:0004) across READMEs, specs, source comments, and tests
- [DOCS]: Removed stale OpenGrep references from capability-patterns.yml, checks-readonly.md, pyproject.toml
- [DOCS]: Removed stale `levels.yml` from bundled config rule (removed from bundled in 0.3.0)
- [MCP]: Explain tool description now requires full coordinate IDs (matching memory note)
- [DOCS]: Updated modules.md levels section — framework uses capabilities (not required_rules)
- [CORE]: File discovery used project root instead of scan root — agent detection and feature scanning now scoped to target directory
- [CORE]: Content rule violations now attributed to root instruction file (`CLAUDE.md`) instead of skill files or scoped snippets
- [CORE]: Per-file size violations (`line_count`, `byte_size`) now attributed to the violating file, not the rule-level target
- [CORE]: Cache hash crash on non-UTF8 instruction files (`UnicodeDecodeError` now caught)
- [CORE]: Feature merge in capability detection used overwrite instead of OR — filesystem-detected features could be lost
- [CORE]: Regex compiler crash on malformed rule YAML with non-list `rules` field
- [CORE]: Removed duplicate `dedupe_violations` from scorer (canonical copy lives in sarif module)
- [CORE]: Regex engine SARIF locations now relative to scan root instead of absolute paths (fixes ugly `../../` display for out-of-CWD projects)
- [CORE]: Compiler crash on binary YAML files (UnicodeDecodeError)
- [CORE]: Mechanical checks crash on string args from YAML (type coercion via `_safe_float`)
- [CORE]: Invalid severity in agent config no longer crashes registry (logs warning, keeps original)
- [CORE]: `is_initialized()` now checks for `core/` subdirectory, not just rules path existence
- [CORE]: Negated deterministic handler reuses `resolve_location()` instead of inline template logic
- [CLI]: Exit code 2 for input errors (bad path, missing args), exit 1 for violations
- [CLI]: Improved help text for target and agent arguments
- [CLI]: First-run feedback: logs "Downloading rules framework..." before auto-init
- [CLI]: User-friendly error wrapping for download failures (httpx)
- [CLI]: Word-boundary truncation for level labels, violation messages, and semantic rule titles
- [CLI]: JSON output returns valid structure when no instruction files found
- [MCP]: Tool helpers now catch `ValueError`/`RuntimeError` from validation (matching server handler)
- [MCP]: `explain` tool handles file read errors gracefully instead of crashing
- [MCP]: Narrowed exception handling from broad `Exception` to specific types
- [MCP]: Added `is_dir()` validation to all tool handlers
- [MCP]: Improved tool descriptions with output format info and examples
- [MCP]: Judge tool returns detailed `{recorded, failed}` feedback instead of silent `{recorded: 0}`
- [MCP]: Judge tool truncates verdict reasons to 40 chars in response (full reason still cached); tool description and semantic workflow guide agents to use brief reasons
- [CORE]: `detect_orphan_features` crash on L0 projects (no instruction files) — MCP validate returned cryptic error
- [CLI]: Double analytics recording — engine and check command both called `record_scan` on every run
- [CLI]: `dismiss` command wrote to wrong cache when run from subdirectory (used target instead of project root)
- [PERF]: Agent detection called once per validation and cached across MCP invocations — eliminates redundant recursive glob scans
- [PERF]: Rule loading cached across MCP invocations — eliminates repeated frontmatter YAML parsing
- [PERF]: Template variable binding hoisted out of per-rule loop (39 → 1 call)
- [PERF]: Glob target resolution cached per session (579 → ~5 unique glob calls)
- [PERF]: Path-based pre-grouping avoids O(files × checks) inner loop for path-filtered checks
- [PERF]: Combined regex patterns batch simple checks into alternation with named groups
- [PERF]: Combined pattern builder now accepts inline-flag and either-pattern checks
- [PERF]: Non-matching files skipped before I/O (text check + read deferred until path filter matches)
- [PERF]: Redundant `bind_instruction_files` call eliminated when vars already bound
- [PERF]: CSafeLoader used for YAML parsing when C extension available (~3x faster)
- [PERF]: Template resolution reads file once instead of twice (has_templates + resolve)
- [PERF]: Capability detection uses first-match-only early exit
- [TEST]: Added unit tests for semantic request building (12 tests)
- [TEST]: Added unit tests for applicability detection and rule filtering (14 tests)
- [TEST]: Added unit tests for engine helper cache filtering (6 tests)
- [TEST]: Added type safety tests for mechanical checks with string/invalid args
- [TEST]: Updated MCP e2e tests for JSON output, content-aware circuit breaker, and semantic workflow
- [TEST]: MCP e2e test includes `heal` tool in expected tool set
- [TEST]: Scan scope containment tests — nested projects, backbone walk-up, agent bypass (10 tests)
- [TEST]: Behavioral contract tests — exit codes, JSON schema, scan scope, text output, flags, map, dismiss, judge, explain, version, config, delta (48 tests)
- [TEST]: Heal command behavioral tests — auto-fix, pass/fail/dismiss/skip verdicts, cache persistence, summary counts (8 tests)
